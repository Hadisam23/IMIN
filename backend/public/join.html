<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Join Game - Im In</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --accent-blue: #4B6BFB;
      --accent-blue-light: #6B8AFF;
      --success-green: #22C55E;
      --warning-orange: #F59E0B;
      --error-red: #EF4444;
      --bg-primary: #F2F2F7;
      --bg-card: #FFFFFF;
      --text-primary: #000000;
      --text-secondary: #8E8E93;
      --border-color: #E5E5EA;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --accent-blue: #6B8AFF;
        --bg-primary: #000000;
        --bg-card: #1C1C1E;
        --text-primary: #FFFFFF;
        --text-secondary: #8E8E93;
        --border-color: #38383A;
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      padding: 16px;
      color: var(--text-primary);
    }

    .container {
      max-width: 420px;
      margin: 0 auto;
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .sport-icon {
      width: 44px;
      height: 44px;
      background: rgba(75, 107, 251, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .header-text h1 {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .header-text .subtitle {
      font-size: 15px;
      color: var(--text-secondary);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      margin-left: auto;
    }

    .status-pill .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .status-open {
      background: rgba(34, 197, 94, 0.12);
      color: var(--success-green);
    }
    .status-open .dot { background: var(--success-green); }

    .status-full {
      background: rgba(245, 158, 11, 0.12);
      color: var(--warning-orange);
    }
    .status-full .dot { background: var(--warning-orange); }

    .status-locked {
      background: rgba(75, 107, 251, 0.12);
      color: var(--accent-blue);
    }
    .status-locked .dot { background: var(--accent-blue); }

    .status-cancelled {
      background: rgba(142, 142, 147, 0.12);
      color: var(--text-secondary);
    }
    .status-cancelled .dot { background: var(--text-secondary); }

    .info-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 15px;
      color: var(--text-secondary);
    }

    .info-row .icon {
      width: 20px;
      text-align: center;
      color: var(--accent-blue);
    }

    .progress-section {
      margin-top: 20px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .progress-header .label {
      color: var(--text-secondary);
    }

    .progress-header .count {
      font-weight: 600;
      color: var(--accent-blue);
    }

    .progress-header .count.full {
      color: var(--warning-orange);
    }

    .progress-bar {
      height: 6px;
      background: var(--border-color);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent-blue);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .progress-fill.full {
      background: var(--warning-orange);
    }

    .players-list {
      margin-top: 16px;
    }

    .players-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .player-item {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .player-item:last-child {
      border-bottom: none;
    }

    .player-avatar {
      width: 36px;
      height: 36px;
      background: var(--accent-blue);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-weight: 600;
      color: #fff;
      font-size: 14px;
    }

    .player-name {
      font-size: 15px;
      font-weight: 500;
    }

    .empty-players {
      text-align: center;
      padding: 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-primary);
      border: none;
      border-radius: 10px;
      font-size: 16px;
      color: var(--text-primary);
      outline: none;
      transition: box-shadow 0.2s;
    }

    .form-input:focus {
      box-shadow: 0 0 0 2px var(--accent-blue);
    }

    .form-input::placeholder {
      color: var(--text-secondary);
    }

    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 14px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
      opacity: 0.9;
    }

    .message {
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 16px;
      text-align: center;
      font-weight: 500;
      font-size: 15px;
    }

    .message.success {
      background: rgba(34, 197, 94, 0.12);
      color: var(--success-green);
    }

    .message.error {
      background: rgba(239, 68, 68, 0.12);
      color: var(--error-red);
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    .loading-text {
      color: var(--text-secondary);
      font-size: 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }

    .branding {
      text-align: center;
      margin-top: 24px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .branding a {
      color: var(--accent-blue);
      text-decoration: none;
      font-weight: 500;
    }

    /* Confirmed State */
    .confirmed-state {
      text-align: center;
      padding: 20px 0;
    }

    .confirmed-icon {
      width: 64px;
      height: 64px;
      background: var(--success-green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 32px;
      color: #fff;
    }

    .confirmed-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .confirmed-name {
      font-size: 17px;
      font-weight: 600;
      color: var(--accent-blue);
      margin-bottom: 4px;
    }

    .confirmed-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .btn-secondary {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      font-size: 15px;
      padding: 12px;
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-primary);
    }

    /* Dropped State */
    .dropped-state {
      text-align: center;
      padding: 20px 0;
    }

    .dropped-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .dropped-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .dropped-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    /* Confirm Dialog */
    .confirm-dialog {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px 20px;
      text-align: center;
    }

    .confirm-dialog h3 {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .confirm-dialog p {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .confirm-dialog .btn-group {
      display: flex;
      gap: 12px;
    }

    .confirm-dialog .btn {
      flex: 1;
    }

    .btn-danger {
      background: var(--error-red);
      color: #fff;
    }

    .btn-cancel {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 100;
    }

    .overlay.hidden {
      display: none;
    }

    /* Highlight current player in list */
    .player-item.you {
      background: rgba(75, 107, 251, 0.08);
      margin: 0 -10px;
      padding: 10px;
      border-radius: 10px;
    }

    .player-item.you .player-name::after {
      content: ' (You)';
      color: var(--accent-blue);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading State -->
    <div id="loading" class="card loading">
      <div class="spinner"></div>
      <p class="loading-text">Loading game...</p>
    </div>

    <!-- Error State -->
    <div id="error-state" class="card hidden">
      <div class="message error" id="error-message">Game not found</div>
    </div>

    <!-- Game Content -->
    <div id="game-content" class="hidden">
      <!-- Game Info Card -->
      <div class="card">
        <div class="header">
          <div class="sport-icon" id="sport-icon">‚öΩ</div>
          <div class="header-text">
            <h1 id="sport-name">Football</h1>
            <div class="subtitle" id="game-time">Saturday, Jan 20 at 4:00 PM</div>
          </div>
          <div class="status-pill status-open" id="status-badge">
            <span class="dot"></span>
            <span id="status-text">Open</span>
          </div>
        </div>

        <div class="info-row">
          <span class="icon">üìç</span>
          <span id="game-location">Central Park Field 3</span>
        </div>

        <div class="info-row">
          <span class="icon">üéØ</span>
          <span id="game-level">Intermediate</span>
        </div>

        <div class="progress-section">
          <div class="progress-header">
            <span class="label">Players</span>
            <span class="count" id="player-count">7 / 10</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 70%"></div>
          </div>
        </div>

        <div class="players-list">
          <div class="players-title">Who's Playing</div>
          <div id="players-list">
            <!-- Players will be inserted here -->
          </div>
        </div>
      </div>

      <!-- Join Form Card -->
      <div class="card" id="join-form-card">
        <div id="message-container"></div>

        <form id="join-form">
          <div class="form-group">
            <label class="form-label">Your Name</label>
            <input type="text" class="form-input" id="name-input" placeholder="Enter your name" required>
          </div>

          <div class="form-group">
            <label class="form-label">Phone Number</label>
            <input type="tel" class="form-input" id="phone-input" placeholder="10-digit phone number" maxlength="14" required>
          </div>

          <button type="submit" class="btn btn-primary" id="join-btn">I'm In!</button>
        </form>
      </div>

      <!-- Confirmed State Card (hidden by default) -->
      <div class="card hidden" id="confirmed-card">
        <div class="confirmed-state">
          <div class="confirmed-icon">‚úì</div>
          <h2 class="confirmed-title">You're In!</h2>
          <p class="confirmed-name" id="confirmed-name"></p>
          <p class="confirmed-subtitle">See you at the game</p>
        </div>
        <button class="btn btn-secondary" id="cant-make-it-btn">Can't make it anymore?</button>
      </div>

      <!-- Dropped State Card (hidden by default) -->
      <div class="card hidden" id="dropped-card">
        <div class="dropped-state">
          <div class="dropped-icon">üëã</div>
          <h2 class="dropped-title">You've Dropped Out</h2>
          <p class="dropped-subtitle">Your spot has been freed for someone else</p>
        </div>
        <button class="btn btn-primary" id="rejoin-btn">Changed your mind? Rejoin</button>
      </div>
    </div>

    <div class="branding">
      Powered by <a href="#">Im In</a>
    </div>
  </div>

  <!-- Confirmation Dialog Overlay -->
  <div class="overlay hidden" id="confirm-overlay">
    <div class="confirm-dialog">
      <h3>Things happen.</h3>
      <p>This will free your spot so someone else can join.</p>
      <div class="btn-group">
        <button class="btn btn-cancel" id="keep-me-btn">Keep me in</button>
        <button class="btn btn-danger" id="confirm-drop-btn">Drop out</button>
      </div>
    </div>
  </div>

  <script>
    const gameId = window.location.pathname.split('/').pop();
    const API_BASE = window.location.origin;
    const STORAGE_KEY = `imin_game_${gameId}`;

    let gameData = null;
    let participationState = null; // { playerId, playerName, phone, status: 'confirmed' | 'dropped' }

    // Sport icons mapping
    const sportIcons = {
      'football': '‚öΩ',
      'soccer': '‚öΩ',
      'basketball': 'üèÄ',
      'tennis': 'üéæ',
      'padel': 'üéæ',
      'volleyball': 'üèê'
    };

    // DOM Elements
    const loadingEl = document.getElementById('loading');
    const errorStateEl = document.getElementById('error-state');
    const errorMessageEl = document.getElementById('error-message');
    const gameContentEl = document.getElementById('game-content');
    const joinFormCard = document.getElementById('join-form-card');
    const joinForm = document.getElementById('join-form');
    const joinBtn = document.getElementById('join-btn');
    const messageContainer = document.getElementById('message-container');
    const confirmedCard = document.getElementById('confirmed-card');
    const droppedCard = document.getElementById('dropped-card');
    const confirmOverlay = document.getElementById('confirm-overlay');

    // Load participation state from localStorage
    function loadParticipationState() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          participationState = JSON.parse(stored);
          return participationState;
        }
      } catch (e) {
        console.error('Failed to load participation state:', e);
      }
      return null;
    }

    // Save participation state to localStorage
    function saveParticipationState(state) {
      try {
        participationState = state;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error('Failed to save participation state:', e);
      }
    }

    // Clear participation state
    function clearParticipationState() {
      participationState = null;
      localStorage.removeItem(STORAGE_KEY);
    }

    // Check if player is still in the game
    function isPlayerStillInGame(game, playerId) {
      if (!game.players || !playerId) return false;
      return game.players.some(p => p.id === playerId);
    }

    // Format date for display
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const options = {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      };
      return date.toLocaleDateString('en-US', options);
    }

    // Get initials from name
    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Update status badge
    function updateStatusBadge(status) {
      const badge = document.getElementById('status-badge');
      const statusText = document.getElementById('status-text');
      badge.className = 'status-pill';

      switch (status) {
        case 'open':
          badge.classList.add('status-open');
          statusText.textContent = 'Open';
          break;
        case 'full':
          badge.classList.add('status-full');
          statusText.textContent = 'Full';
          break;
        case 'locked':
          badge.classList.add('status-locked');
          statusText.textContent = 'Locked';
          break;
        case 'cancelled':
          badge.classList.add('status-cancelled');
          statusText.textContent = 'Cancelled';
          break;
      }
    }

    // Render game data
    function renderGame(game) {
      gameData = game;

      const sportLower = game.sport.toLowerCase();
      document.getElementById('sport-icon').textContent = sportIcons[sportLower] || 'üèÜ';
      document.getElementById('sport-name').textContent = game.sport;
      document.getElementById('game-time').textContent = formatDate(game.time);
      document.getElementById('game-location').textContent = game.location;
      document.getElementById('game-level').textContent = game.level;

      const playerCount = game.playerCount || 0;
      const maxPlayers = game.maxPlayers;
      const percentage = (playerCount / maxPlayers) * 100;
      const isFull = percentage >= 100;

      const countEl = document.getElementById('player-count');
      countEl.textContent = `${playerCount} / ${maxPlayers}`;
      countEl.classList.toggle('full', isFull);

      const progressFill = document.getElementById('progress-fill');
      progressFill.style.width = `${percentage}%`;
      progressFill.classList.toggle('full', isFull);

      updateStatusBadge(game.status);

      // Render players list (highlight current player if registered)
      const playersList = document.getElementById('players-list');
      const currentPlayerId = participationState?.playerId;
      if (game.players && game.players.length > 0) {
        playersList.innerHTML = game.players.map(player => `
          <div class="player-item${player.id === currentPlayerId ? ' you' : ''}">
            <div class="player-avatar">${escapeHtml(getInitials(player.name))}</div>
            <span class="player-name">${escapeHtml(player.name)}</span>
          </div>
        `).join('');
      } else {
        playersList.innerHTML = '<p class="empty-players">No players yet. Be the first to join!</p>';
      }

      // Determine which card to show based on participation state
      showAppropriateCard(game);
    }

    // Show the appropriate card based on game status and participation state
    function showAppropriateCard(game) {
      // Hide all action cards first
      joinFormCard.classList.add('hidden');
      confirmedCard.classList.add('hidden');
      droppedCard.classList.add('hidden');

      // Remove any existing status message cards
      document.querySelectorAll('.status-message-card').forEach(el => el.remove());

      // Check if player is registered and still in game
      if (participationState && participationState.status === 'confirmed') {
        if (isPlayerStillInGame(game, participationState.playerId)) {
          // Player is confirmed and in the game
          document.getElementById('confirmed-name').textContent = participationState.playerName;
          confirmedCard.classList.remove('hidden');
          return;
        } else {
          // Player was removed (maybe by organizer) - clear state
          clearParticipationState();
        }
      }

      // Check if player previously dropped out
      if (participationState && participationState.status === 'dropped') {
        // Show dropped state with rejoin option (if game is open)
        if (game.status === 'open') {
          droppedCard.classList.remove('hidden');
        } else {
          // Can't rejoin, clear state and show status message
          clearParticipationState();
          showStatusMessage(game);
        }
        return;
      }

      // No participation state - show join form or status message
      if (game.status === 'open') {
        joinFormCard.classList.remove('hidden');
      } else {
        showStatusMessage(game);
      }
    }

    // Show status message for closed games
    function showStatusMessage(game) {
      let message = '';
      if (game.status === 'full') {
        message = 'This game is full. Check back later for cancellations.';
      } else if (game.status === 'locked') {
        message = 'This game has been locked by the organizer.';
      } else if (game.status === 'cancelled') {
        message = 'This game has been cancelled.';
      }

      if (message) {
        const msgCard = document.createElement('div');
        msgCard.className = 'card status-message-card';
        msgCard.innerHTML = `<div class="message error">${message}</div>`;
        joinFormCard.parentNode.insertBefore(msgCard, joinFormCard);
      }
    }

    // Fetch game data
    async function fetchGame() {
      try {
        // Load any existing participation state first
        loadParticipationState();

        const response = await fetch(`${API_BASE}/games/${gameId}`);

        if (!response.ok) {
          throw new Error('Game not found');
        }

        const game = await response.json();

        // If we have a participation state, verify player is still in game
        if (participationState && participationState.status === 'confirmed') {
          if (!isPlayerStillInGame(game, participationState.playerId)) {
            // Player was removed - clear the state
            clearParticipationState();
          }
        }

        loadingEl.classList.add('hidden');
        gameContentEl.classList.remove('hidden');

        renderGame(game);
      } catch (error) {
        loadingEl.classList.add('hidden');
        errorStateEl.classList.remove('hidden');
        errorMessageEl.textContent = error.message || 'Failed to load game';
      }
    }

    // Handle form submission (join game)
    joinForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('name-input').value.trim();
      const phone = document.getElementById('phone-input').value.trim();

      if (!name) {
        messageContainer.innerHTML = '<div class="message error">Please enter your name</div>';
        return;
      }

      if (!phone) {
        messageContainer.innerHTML = '<div class="message error">Please enter your phone number</div>';
        return;
      }

      // Validate phone is exactly 10 digits
      const digitsOnly = phone.replace(/\D/g, '');
      if (digitsOnly.length !== 10) {
        messageContainer.innerHTML = '<div class="message error">Phone number must be exactly 10 digits</div>';
        return;
      }

      joinBtn.disabled = true;
      joinBtn.textContent = 'Joining...';

      try {
        const response = await fetch(`${API_BASE}/games/${gameId}/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, phone: phone || null })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to join');
        }

        // Find the player ID from the response
        const joinedPlayer = data.game?.players?.find(p => p.phone === phone);
        if (joinedPlayer) {
          // Save participation state
          saveParticipationState({
            playerId: joinedPlayer.id,
            playerName: name,
            phone: phone,
            status: 'confirmed'
          });
        }

        // Update game display (this will show the confirmed card)
        if (data.game) {
          renderGame(data.game);
        }
      } catch (error) {
        messageContainer.innerHTML = `<div class="message error">${escapeHtml(error.message)}</div>`;
        joinBtn.disabled = false;
        joinBtn.textContent = "I'm In!";
      }
    });

    // Handle "Can't make it" button
    document.getElementById('cant-make-it-btn').addEventListener('click', () => {
      confirmOverlay.classList.remove('hidden');
    });

    // Handle "Keep me in" button
    document.getElementById('keep-me-btn').addEventListener('click', () => {
      confirmOverlay.classList.add('hidden');
    });

    // Handle confirm drop out
    document.getElementById('confirm-drop-btn').addEventListener('click', async () => {
      if (!participationState || !participationState.playerId) {
        confirmOverlay.classList.add('hidden');
        return;
      }

      const dropBtn = document.getElementById('confirm-drop-btn');
      dropBtn.disabled = true;
      dropBtn.textContent = 'Dropping...';

      try {
        const response = await fetch(`${API_BASE}/games/${gameId}/players/${participationState.playerId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to drop out');
        }

        // Update state to dropped
        saveParticipationState({
          ...participationState,
          status: 'dropped'
        });

        confirmOverlay.classList.add('hidden');

        // Update game display
        if (data.game) {
          renderGame(data.game);
        }
      } catch (error) {
        alert(error.message);
        dropBtn.disabled = false;
        dropBtn.textContent = 'Drop out';
      }
    });

    // Handle rejoin button
    document.getElementById('rejoin-btn').addEventListener('click', () => {
      // Clear the dropped state and show join form
      clearParticipationState();
      droppedCard.classList.add('hidden');
      joinFormCard.classList.remove('hidden');

      // Pre-fill the form with previous data if available
      // (Note: we cleared the state, so this won't work. For better UX,
      //  we could store name/phone separately)
    });

    // Initial load
    fetchGame();
  </script>
</body>
</html>
